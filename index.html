<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆÙ„Ù‘Ø¯ Ø®Ø·Ø§Ø¨Ø§Øª Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„ - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0f5b40;
            --ai-color: #10a37f; /* Ù„ÙˆÙ† ChatGPT */
            --paper-width: 210mm;
            --paper-height: 297mm;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            display: flex;
            gap: 20px;
        }

        /* --- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… --- */
        .controls {
            flex: 1;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            height: fit-content;
            overflow-y: auto;
            max-height: 95vh;
        }

        .controls h2, .controls h3 { color: var(--primary-color); font-family: 'Tajawal', sans-serif; }
        .controls h3 { font-size: 16px; margin-top: 20px; border-bottom: 2px solid #eee; padding-bottom: 5px;}
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .input-group input, .input-group select, .input-group textarea {
            width: 95%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        

        /* Ø¹Ù†Ø§ØµØ± Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© */
        .input-group.opt label { display:flex; align-items:center; gap:10px; }
        .input-group.opt input[type="checkbox"] { transform: scale(1.1); }
        .input-group.disabled { opacity: 0.65; }
        .input-group.disabled input,
        .input-group.disabled textarea,
        .input-group.disabled select {
            background: #f3f3f3;
            pointer-events: none;
        }
    .ai-section {
            background-color: #e9f7f3;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--ai-color);
        }

        .actions { margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.3s;
            text-align: center;
        }
        .btn-update { background-color: var(--primary-color); }
        .btn-word { background-color: #2b579a; }
        .btn-print { background-color: #555; }
        .btn-ai { background-color: var(--ai-color); }

        /* --- ÙˆØ±Ù‚Ø© Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (A4) --- */
        .preview-container {
            flex: 2;
            display: flex;
            justify-content: center;
            background: #ccc;
            padding: 20px;
            overflow: auto;
        }

        #letter-page {
            width: var(--paper-width);
            min-height: var(--paper-height);
            background-color: white;
            background-image: url('bg.png'); 
            background-size: 100% 100%;
            background-repeat: no-repeat;
            
            /* Ø§Ù„Ù‡ÙˆØ§Ù…Ø´ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© */
            padding: 5cm 3.175cm 2.75cm 3.175cm; 
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            position: relative;
            
            /* Ø§Ù„Ø®Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ */
            font-family: 'ae_AlMohanad', 'Traditional Arabic', serif;
            font-size: 16pt;
            line-height: 1.5;
            color: black;
            text-align: justify;
        }

        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
        .header-section { margin-bottom: 20px; }
        .greeting { margin-bottom: 15px; }
        .paragraph { margin-bottom: 10px; text-align: justify; }
        
        .closing-section {
            margin-top: 40px;
            text-align: center; 
        }
        
        .signature-section {
            margin-top: 20px;
            float: left;
            text-align: center;
            min-width: 250px;
        }

        @media print {
            body * { visibility: hidden; }
            #letter-page, #letter-page * { visibility: visible; }
            #letter-page {
                position: absolute;
                left: 0;
                top: 0;
                margin: 0;
                box-shadow: none;
                width: 210mm;
                height: 297mm;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            .controls, .preview-container { padding: 0; background: white; }
        }
    </style>
</head>
<body>

    <div class="controls">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø·Ø§Ø¨</h2>
        
        <div class="input-group">
            <label>Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡:</label>
            <input type="text" id="recipient" value="Ø±Ø¦ÙŠØ³ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„">
        </div>
        
        <div class="input-group">
            <label>Ø§Ù„Ø¯Ø¹Ø§Ø¡:</label>
            <input type="text" id="invocation" value="Ø­ÙØ¸Ù‡ Ø§Ù„Ù„Ù‡">
        </div>

        <hr>
        <h3>Ø¹Ù†Ø§ØµØ± Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (ÙØ¹Ù‘Ù„ Ù…Ø§ ØªØ­ØªØ§Ø¬Ù‡ ÙÙ‚Ø·)</h3>
        <div style="display:flex; gap:10px; margin-bottom:10px;">
            <button class="btn" style="background-color:#777; flex:1;" onclick="setAllOpts(true)">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
            <button class="btn" style="background-color:#777; flex:1;" onclick="setAllOpts(false)">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
        </div>

        <div class="input-group opt" data-opt="ref_num">
            <label><input type="checkbox" id="use_ref_num" checked onchange="toggleOpt('use_ref_num','ref_num')"> Ø±Ù‚Ù… Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ù…Ø´Ø§Ø± Ø¥Ù„ÙŠÙ‡:</label>
            <input type="text" id="ref_num" value="4229">
        </div>

        <div class="input-group opt" data-opt="ref_date_h">
            <label><input type="checkbox" id="use_ref_date_h" checked onchange="toggleOpt('use_ref_date_h','ref_date_h')"> Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ:</label>
            <input type="text" id="ref_date_h" value="29/7/1447Ù‡Ù€">
        </div>

        <div class="input-group opt" data-opt="ref_date_g">
            <label><input type="checkbox" id="use_ref_date_g" checked onchange="toggleOpt('use_ref_date_g','ref_date_g')"> Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ÙŠ:</label>
            <input type="text" id="ref_date_g" value="18/1/2026Ù…">
        </div>

        <div class="input-group opt" data-opt="organizer">
            <label><input type="checkbox" id="use_organizer" checked onchange="toggleOpt('use_organizer','organizer')"> Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠØ©:</label>
            <input type="text" id="organizer" value="Ù‡ÙŠØ¦Ø© Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©">
        </div>

        <div class="input-group opt" data-opt="letter_idea">
            <label><input type="checkbox" id="use_letter_idea" checked onchange="toggleOpt('use_letter_idea','letter_idea')"> ÙÙƒØ±Ø© Ø§Ù„Ø®Ø·Ø§Ø¨ (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ø³Ù… Ø§Ù„ÙØ¹Ø§Ù„ÙŠØ©/Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹):</label>
            <textarea id="letter_idea" rows="2" placeholder="Ø§ÙƒØªØ¨ ÙÙƒØ±Ø© Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø£Ù† ÙŠØ¨Ù†ÙŠ Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ†...">Ø¯Ø¹ÙˆØ© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù…Ù„ØªÙ‚Ù‰ â€œØªÙ…ÙƒÙŠÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©â€</textarea>
        </div>

        <div class="input-group opt" data-opt="event_datetime">
            <label><input type="checkbox" id="use_event_datetime" checked onchange="toggleOpt('use_event_datetime','event_datetime')"> Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„Ø²Ù…Ø§Ù†:</label>
            <input type="text" id="event_datetime" value="ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ 10 ÙØ¨Ø±Ø§ÙŠØ± 2026Ù… Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ø§ Ø¨Ù…Ù‚Ø± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶">
        </div>

        <div class="input-group opt" data-opt="my_dept">
            <label><input type="checkbox" id="use_my_dept" checked onchange="toggleOpt('use_my_dept','my_dept')"> Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ù†Ø­Ù†):</label>
            <input type="text" id="my_dept" value="Ø¹Ù…Ø§Ø¯Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù…Ø«Ù„Ø© ÙÙŠ ÙˆØ­Ø¯Ø© Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø©">
        </div>

        <div class="ai-section">
            <h3 style="margin-top: 0;">ğŸ¤– ØµÙŠØ§ØºØ© Ø§Ù„Ù…ØªÙ† Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
            
            <button class="btn btn-ai" style="width: 100%; margin-bottom: 10px;" onclick="generateAIPrompt()">1. ØªÙˆÙ„ÙŠØ¯ Ø£Ù…Ø± (Prompt) Ù„Ù„Ù†Ø³Ø®</button>
            
            <textarea id="ai_prompt" rows="4" readonly placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø¬Ø§Ù‡Ø² Ù„Ù„Ù†Ø³Ø®..."></textarea>
            
            <button class="btn" style="background-color: #333; width: 100%; margin-top: 5px; margin-bottom: 15px;" onclick="copyPrompt()">ğŸ“‹ 2. Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø± (Ù„Ù€ Gemini / ChatGPT)</button>
            
            <div class="input-group">
                <label>3. Ø§Ù„ØµÙ‚ Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù‡Ù†Ø§ (Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ):</label>
                <textarea id="ai_response" rows="7" oninput="generateLetter()">Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø®Ø·Ø§Ø¨ Ø³Ø¹Ø§Ø¯ØªÙƒÙ… Ø±Ù‚Ù… (4229) ÙˆØªØ§Ø±ÙŠØ® (29/7/1447Ù‡Ù€) Ø§Ù„Ù…ÙˆØ§ÙÙ‚ (18/1/2026Ù…)ØŒ ÙˆØ¥Ù„Ù‰ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø§Ù„ÙƒØ±ÙŠÙ…Ø© Ù…Ù† Ù‡ÙŠØ¦Ø© Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ© ÙÙŠ Ù…Ù„ØªÙ‚Ù‰ â€œØªÙ…ÙƒÙŠÙ† Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø£Ø´Ø®Ø§Øµ Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© ÙÙŠ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©â€ØŒ ÙˆØ§Ù„Ø°ÙŠ Ø³ÙŠØ¹Ù‚Ø¯ ÙŠÙˆÙ… Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ 10 ÙØ¨Ø±Ø§ÙŠØ± 2026Ù… Ù…Ù† Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 ØµØ¨Ø§Ø­Ø§ Ø¨Ù…Ù‚Ø± Ø§Ù„Ù‡ÙŠØ¦Ø© Ø¨Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ ØªØ¤ÙƒØ¯ Ø¹Ù…Ø§Ø¯Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù…Ø«Ù„Ø© ÙÙŠ ÙˆØ­Ø¯Ø© Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© Ø¹Ù„Ù‰ Ø£Ù‡Ù…ÙŠØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù„Ù„Ø¬Ø§Ù…Ø¹Ø©Ø› Ø¨ÙˆØµÙÙ‡Ø§ ÙØ±ØµØ© Ù„ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø®Ø¨Ø±Ø§Øª ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„ØªØ¹Ø§ÙˆÙ†ØŒ ÙˆÙ…Ù†Ø§Ù‚Ø´Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„ØªØ³Ø¬ÙŠÙ„ØŒ ÙˆØ§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ØªØ·ÙˆÙŠØ±ÙŠØ© Ø§Ù„ØªÙŠ ØªØ³Ù‡Ù… ÙÙŠ Ø±ÙØ¹ Ø§Ù„ÙƒÙØ§Ø¡Ø©ØŒ Ø¨Ù…Ø§ ÙŠØªÙ…Ø§Ø´Ù‰ Ù…Ø¹ Ù…Ø³ØªÙ‡Ø¯ÙØ§Øª Ø±Ø¤ÙŠØ© Ø§Ù„Ù…Ù…Ù„ÙƒØ© 2030.
Ø¹Ù„ÙŠÙ‡ØŒ Ù‚Ø¯ ÙŠØ±Ù‰ Ø³Ø¹Ø§Ø¯ØªÙƒÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù…Ø§Ø¯Ø© Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ù…Ø«Ù„Ø© ÙÙŠ ÙˆØ­Ø¯Ø© Ø°ÙˆÙŠ Ø§Ù„Ø¥Ø¹Ø§Ù‚Ø© Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ù„ØªÙ‚Ù‰.</textarea>
            </div>
        </div>

        <hr>
        <div class="input-group">
            <label>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ø§Ù„Ù…Ù†ØµØ¨):</label>
            <input type="text" id="signer_title" value="Ø¹Ù…ÙŠØ¯ Ø´Ø¤ÙˆÙ† Ø§Ù„Ø·Ù„Ø§Ø¨">
        </div>
        <div class="input-group">
            <label>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ (Ø§Ù„Ø§Ø³Ù…):</label>
            <input type="text" id="signer_name" value="Ø¯. Ù…Ø­Ù…Ø¯ Ø¨Ù† Ù…Ù†Ø§Ø­ÙŠ Ø§Ù„Ø³Ø¨ÙŠØ¹ÙŠ">
        </div>

        <div class="actions">
            <button class="btn btn-update" onclick="generateLetter()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</button>
            <button class="btn btn-word" onclick="exportToWord()">ğŸ“„ ØªØµØ¯ÙŠØ± Word (DOCX)</button>
            <button class="btn btn-print" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
        </div>
    </div>

    <div class="preview-container">
        <div id="letter-page">
            <div class="content-layer" id="letter-content">
                </div>
        </div>
    </div>

    <script>

        // ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
        function toggleOpt(chkId, fieldId) {
            const chk = document.getElementById(chkId);
            const field = document.getElementById(fieldId);
            if (!chk || !field) return;
            field.disabled = !chk.checked;
            const group = field.closest('.input-group');
            if (group) group.classList.toggle('disabled', !chk.checked);
        }

        function syncOpts() {
            toggleOpt('use_ref_num','ref_num');
            toggleOpt('use_ref_date_h','ref_date_h');
            toggleOpt('use_ref_date_g','ref_date_g');
            toggleOpt('use_organizer','organizer');
            toggleOpt('use_letter_idea','letter_idea');
            toggleOpt('use_event_datetime','event_datetime');
            toggleOpt('use_my_dept','my_dept');
        }

        function setAllOpts(state) {
            const ids = [
                'use_ref_num','use_ref_date_h','use_ref_date_g',
                'use_organizer','use_letter_idea','use_event_datetime','use_my_dept'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = state;
            });
            syncOpts();
        }

        document.addEventListener('DOMContentLoaded', syncOpts);

        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù€ Prompt Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function generateAIPrompt() {
            const recipient = (document.getElementById('recipient')?.value || '').trim() || 'Ø±Ø¦ÙŠØ³ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„';

            // Ø§Ù„ÙÙƒØ±Ø© (Ø£Ø³Ø§Ø³ Ø§Ù„ØµÙŠØ§ØºØ©)
            const ideaOn = document.getElementById('use_letter_idea')?.checked;
            const idea = ideaOn ? ((document.getElementById('letter_idea')?.value || '').trim()) : '';

            // Ø¹Ù†Ø§ØµØ± Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
            const refNumOn = document.getElementById('use_ref_num')?.checked;
            const refDateHOn = document.getElementById('use_ref_date_h')?.checked;
            const refDateGOn = document.getElementById('use_ref_date_g')?.checked;
            const organizerOn = document.getElementById('use_organizer')?.checked;
            const eventDTOn = document.getElementById('use_event_datetime')?.checked;
            const myDeptOn = document.getElementById('use_my_dept')?.checked;

            const refNum = (document.getElementById('ref_num')?.value || '').trim();
            const refDateH = (document.getElementById('ref_date_h')?.value || '').trim();
            const refDateG = (document.getElementById('ref_date_g')?.value || '').trim();
            const organizer = (document.getElementById('organizer')?.value || '').trim();
            const eventDateTime = (document.getElementById('event_datetime')?.value || '').trim();
            const myDept = (document.getElementById('my_dept')?.value || '').trim();

            const bullets = [];
            const add = (txt) => { if (txt && txt.trim()) bullets.push('- ' + txt.trim()); };

            // Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø®Ø·Ø§Ø¨ Ø³Ø§Ø¨Ù‚ (ÙŠØ¬Ù…Ø¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø·)
            if (refNumOn || refDateHOn || refDateGOn) {
                const parts = [];
                if (refNumOn && refNum) parts.push(`Ø±Ù‚Ù… (${refNum})`);
                if (refDateHOn && refDateH) parts.push(`ÙˆØªØ§Ø±ÙŠØ® (${refDateH})`);
                if (refDateGOn && refDateG) parts.push(`Ø§Ù„Ù…ÙˆØ§ÙÙ‚ (${refDateG})`);
                if (parts.length) add(`Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø¥Ù„Ù‰ Ø®Ø·Ø§Ø¨ ${parts.join(' ')}.`);
            }

            if (organizerOn && organizer) add(`Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø§Ø¹ÙŠØ©/Ø§Ù„Ù…Ø¨Ø§Ø¯ÙØ±Ø©: (${organizer}).`);
            if (eventDTOn && eventDateTime) add(`Ø§Ù„Ù…ÙƒØ§Ù† ÙˆØ§Ù„Ø²Ù…Ø§Ù†: (${eventDateTime}).`);
            if (myDeptOn && myDept) add(`Ø§Ù„Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© (Ù†Ø­Ù†): (${myDept}).`);

            const ideaLine = idea ? `ÙÙƒØ±Ø© Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: (${idea}).` : 'ÙÙƒØ±Ø© Ø§Ù„Ø®Ø·Ø§Ø¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: (Ø§ÙƒØªØ¨ Ø§Ù„ÙÙƒØ±Ø© Ù‡Ù†Ø§ Ø«Ù… Ø£Ø¹Ø¯ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ù…Ø±).';
            const closingLine = (myDeptOn && myDept)
                ? `Ø§Ø®ØªÙ… Ø¨Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø§ ÙˆØ±Ø¯ØŒ ÙˆØ¨Ø®Ø§ØµØ© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙƒØ© (${myDept}) ÙˆÙÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù….`
                : 'Ø§Ø®ØªÙ… Ø¨Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù…Ø§ ÙˆØ±Ø¯ ÙˆÙÙ‚ Ø§Ù„Ù†Ø¸Ø§Ù….';

            const promptText = `Ø¨ØµÙØªÙƒ Ø®Ø¨ÙŠØ±Ø§Ù‹ ÙÙŠ ØµÙŠØ§ØºØ© Ø§Ù„Ø®Ø·Ø§Ø¨Ø§Øª Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ø¬Ø§Ù…Ø¹Ø§Øª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŒ Ø§ÙƒØªØ¨ Ù…ØªÙ† Ø®Ø·Ø§Ø¨ Ø±Ø³Ù…ÙŠ (ÙÙ‚Ø±ØªÙŠÙ† Ø¥Ù„Ù‰ Ø«Ù„Ø§Ø« ÙÙ‚Ø±Ø§Øª) Ù…ÙˆØ¬Ù‡ Ø¥Ù„Ù‰ Ø³Ø¹Ø§Ø¯Ø©/ ${recipient} Ø¨Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ù…Ù„Ùƒ ÙÙŠØµÙ„.
${ideaLine}

Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© (Ø£Ø¯Ø±Ø¬Ù‡Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø°ÙƒÙˆØ±Ø© Ø£Ø¯Ù†Ø§Ù‡):
${bullets.length ? bullets.join('\n') : '- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©.'}

Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ§ØºØ©:
- Ø£Ø³Ù„ÙˆØ¨ Ø±Ø³Ù…ÙŠ Ø¯Ù‚ÙŠÙ‚ ÙˆÙˆØ§Ø¶Ø­.
- Ø§Ù„Ù…ØªÙ† ÙÙ‚Ø· Ø¯ÙˆÙ† ØªØ­ÙŠØ© Ø£Ùˆ ØªÙˆÙ‚ÙŠØ¹ Ø£Ùˆ Ø¹Ù†Ø§ÙˆÙŠÙ†.
- ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø± ÙˆØ§Ù„Ø¥Ø·Ø§Ù„Ø© ØºÙŠØ± Ø§Ù„Ù„Ø§Ø²Ù…Ø©.
- ${closingLine}`;

            document.getElementById('ai_prompt').value = promptText;
        }

        // Ø¯Ø§Ù„Ø© Ù†Ø³Ø® Ø§Ù„Ù€ Prompt
        function copyPrompt() {
            const text = document.getElementById('ai_prompt')?.value || '';
            if (!text.trim()) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ù…Ø± Ù„Ù„Ù†Ø³Ø® Ø¨Ø¹Ø¯.');

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø±! Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ ChatGPT/Gemini.'))
                    .catch(() => fallbackCopy(text));
            } else {
                fallbackCopy(text);
            }

            function fallbackCopy(t) {
                const ta = document.createElement('textarea');
                ta.value = t;
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                try { document.execCommand('copy'); alert('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø£Ù…Ø±! Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ ChatGPT/Gemini.'); }
                catch { alert('ØªØ¹Ø°Ø± Ø§Ù„Ù†Ø³Ø® ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. Ø§Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø£Ù…Ø±.'); }
                document.body.removeChild(ta);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø®Ø·Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
        function generateLetter() {
            const recipient = document.getElementById('recipient').value;
            const invocation = document.getElementById('invocation').value;
            // Ø£Ø®Ø° Ø§Ù„Ù†Øµ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø±Ø¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
            const mainContentText = document.getElementById('ai_response').value; 
            
            const signerTitle = document.getElementById('signer_title').value;
            const signerName = document.getElementById('signer_name').value;

            let html = ``;

            // 1. Ø§Ù„Ù…Ø±Ø³Ù„ Ø¥Ù„ÙŠÙ‡
            html += `<div class="header-section">
                        <span style="font-weight:bold;">Ø³Ø¹Ø§Ø¯Ø©/ ${recipient}</span>
                        <span style="float:left; margin-left: 50px;">${invocation}</span>
                     </div>`;

            // 2. Ø§Ù„ØªØ­ÙŠØ©
            html += `<div class="greeting">Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ â€¦ ÙˆØ¨Ø¹Ø¯ØŒ</div>`;

            // 3. Ø§Ù„Ù…ØªÙ† (Ø§Ù„Ù…ÙˆÙ„Ø¯ Ø¨ÙˆØ§Ø³Ø·Ø© AI)
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¥Ù„Ù‰ ÙÙ‚Ø±Ø§Øª HTML
            const paragraphs = mainContentText.split('\n').filter(p => p.trim() !== '');
            paragraphs.forEach(p => {
                html += `<div class="paragraph">${p}</div>`;
            });

            // 4. Ø§Ù„Ø®ØªØ§Ù… ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹
            html += `<div class="closing-section">ÙˆØªÙ‚Ø¨Ù„ÙˆØ§ Ø³Ø¹Ø§Ø¯ØªÙƒÙ… Ø®Ø§Ù„Øµ Ø§Ù„ØªØ­ÙŠØ© ÙˆØ§Ù„ØªÙ‚Ø¯ÙŠØ±ØŒ</div>`;
            html += `<div class="signature-section">
                        <div style="margin-bottom:40px; font-weight:bold;">${signerTitle}</div>
                        <div style="font-weight:bold;">${signerName}</div>
                     </div>`;
            html += `<div style="clear:both;"></div>`;

            document.getElementById('letter-content').innerHTML = html;
        }

        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„ÙˆÙˆØ±Ø¯
        function exportToWord() {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
                "xmlns:w='urn:schemas-microsoft-com:office:word' "+
                "xmlns='http://www.w3.org/TR/REC-html40'>"+
                "<head><meta charset='utf-8'><title>Export HTML to Word</title>"+
                "<style>"+
                "body { font-family: 'ae_AlMohanad', 'Traditional Arabic', serif; font-size: 16pt; direction: rtl; text-align: justify; }" +
                "@page { size: 210mm 297mm; margin: 5cm 3.175cm 2.75cm 3.175cm; }"+
                ".signature-section { float: left; text-align: center; }"+
                ".closing-section { text-align: center; }"+
                "</style></head>"+
                "<body style=\"background-image: url('bg.png'); background-repeat: no-repeat; background-size: 100% 100%;\">";
            
            const content = document.getElementById('letter-content').innerHTML;
            const footer = "</body></html>";
            
            const sourceHTML = header + content + footer;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = 'KFU_Letter_AI.doc';
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        // ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
        generateLetter();
    </script>
</body>
</html>